---
title: "Appendix S3 - Biomass analysis"
author: 
  - name: Renata Diaz
    orcid: 0000-0003-0803-4734
    email: renata.diaz@weecology.org
output: 
   html_document:
     toc: true
bibliography: refs.bib
---

```{r setup, include=FALSE, message = F, warning= F}
knitr::opts_chunk$set(echo = FALSE,  message = F, warning= F)
library(soar)
library(ggplot2)
library(dplyr)
library(nlme)
library(emmeans)

```


<!-- # Data -->

<!-- ## Functions -->

<!-- Data are accessed and processed using functions stored in https://github.com/diazrenata/soar, archived on Zenodo at https://doi.org/10.5281/zenodo.5539880. Install these functions either by running: -->


```{r, eval = F, echo = F}
remotes::install_github("diazrenata/soar")
```

<!-- or by downloading the Zenodo archive and installing the package manually.  -->

<!-- ## Data access -->

<!-- Data can be downloaded directly from the Portal data repository: -->

```{r, echo = F}

plotl <- get_plot_totals(currency = "biomass")

plot_types <- list_plot_types() %>% filter(plot_type == "EE")
```

<!-- For speed and offline access, data files are also included in this repository in the `data` directory: -->

```{r, echo =F}

# plotl <- read.csv(here::here("data", "plotl_biomass.csv"), stringsAsFactors = T)
# plot_types <- read.csv(here::here("data", "plot_types.csv"), stringsAsFactors = T)

```

<!-- For interpretability, translating the era and treatment "names" as RMD coded them for analysis to the corresponding dates: -->

```{r, echo = F}

oera_df <- data.frame(
  oera = c("a_pre_pb", "b_pre_reorg", "c_post_reorg"),
  `Timeperiod` = c("1988-1997", "1997-2010", "2010-2020")
)

oplot_df <- data.frame(
  oplottype = c("CC", "EE"),
  `Treatment` = c("Control", "Exclosure")
)

contrasts_df <- data.frame(
  contrast = c("a_pre_pb - b_pre_reorg", "a_pre_pb - c_post_reorg", "b_pre_reorg - c_post_reorg"),
  Comparison = c("1988-1997 - 1997-2010", "1988-1997 - 2010-2020", "1997-2010 - 2010-2020")
)

```

<!-- ## Balancing exclosure and control plots -->

<!-- Because there are 5 exclosure plots and 4 control plots in these data, we remove 1 exclosure plot to achieve a balanced design. From the 5 possible exclosures to remove, we randomly select 1 using the seed 1977 (the year the Portal Project was initiated).  -->

```{r, echo = F}

plot_types <- plot_types  %>% 
  filter(plot_type == "EE")

set.seed(1977) 
remove_plot <- sample(plot_types$plot, 1, F) # results in removing plot 19

plotl <- plotl %>%
  filter(plot != remove_plot)
```

<!-- ## Treatment-level means and quantities of interest -->

<!-- In order to calculate compensation and the total biomass ratio, it is necessary to take the treatment-level mean total biomass and the  biomass of kangaroo rats and small granivores on control plots. For consistency in the main analysis, we take treatment-level means for all quantities. -->

<!-- Because this necessarily elides some degree of variability between plots with treatment types, we also conducted a provisional analysis incorporating between-plot variability for exclosure plots (but not for control plots), with qualitatively the same results (see appendix S4).  -->

<!-- To take treatment-level means: -->

```{r, echo = F}
# Treatment-level means:
treatl <- plots_to_treatment_means(plotl) 

# Format column types
treatl <- treatl %>%
  mutate(censusdate = as.Date(censusdate),
         oera = ordered(oera),
         oplottype = ordered(oplottype))
```


<!-- Calculate proportional biomass of *C. baileyi* on exclosure and control plots. The `pb_nozero` dataframe omits the first time period, because during that time *C. baileyi* was essentially absent at the site (and the large number of 0s for an entire treatment-by-factor level combination breaks statistical models). -->

```{r, echo = F}
pb <- get_pb(treatl) 

pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)

```

<!-- Calculate total biomass ratio and compensation, comparing exclosure to control plots: -->

```{r, echo =F}
biomass_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)

```

<!-- Calculate kangaroo rat (Dipodomys) proportion of total biomass on control plots: -->

```{r, echo =F}

dipo_c_dat <- get_dipo_c(treatl)

```


<!-- ## Variable names for analyses -->

<!-- The variables used in these analyses, and their definitions. -->

<!-- - `period`: The monthly census period number for each census. Numeric. -->
<!-- - `censusdate`: The date of the monthly census. Date. -->
<!-- - `era`: The "time period", as described in the text. Character, one of `a_pre_pb` (first time period, before *C. baileyi* arrived at the site), `b_pre_reorg` (second time period, after *C. baileyi* established but before the most recent reorganization event), or `c_post_reorg` (third time period, after the last reorganization event). -->
<!-- - `oera`: `era` as an ordered factor, for modeling. Ordered factor. -->
<!-- - `plot_type`: The treatment, either `CC` for control or `EE` for exclosure. Character. -->
<!-- - `oplottype`: `plot_type` as an ordered factor, for modeling. Ordered factor. -->
<!-- - `total_e_rat`, `total_e_rat_ma` (specific to `biomass_ratio`): The ratio of total biomass on exclosure plots relative to control plots, and the 6-month moving average. Numeric, unbounded. For this analysis, note that the values are calculated off of biomass (even though the columns are flagged as "_e" ratio) -->
<!-- - `smgran_comp`, `smgran_comp_ma` (specific to `compensation`): Biomass compensation by small granivores for kangaroo rat removal, and the 6-month moving average. Numeric, unbounded. -->
<!-- - `pb_prop`, `pb_prop_ma` (specific to `pb` and `pb_nozero`): The proportion of treatment-level biomass accounted for by *C. baileyi*, and the 6-month moving average. Numeric, proportion bounded 0-1. -->
<!-- - `dipo_prop`, `dipo_prop_ma` (specific to `dipo_c_dat`): The proportion of treatment-level biomass accounted for by all kangaroo rats, and the 6-month moving average. Numeric, proportion bounded 0-1. -->

# Background

This is a modified version of Appendix S3 from the article “Maintenance of community function through compensation breaks down over time in a desert rodent community” by Renata Diaz and S. K. Morgan Ernest, now published in _Ecology_ [@diaz2022]. 

# Compensation

Compensation refers to the degree to which the remaining species on kangaroo rat removal plots absorb resources made available via kangaroo rat removal (@fig-plot). We fit a generalized least squares (of the form *compensation ~ timeperiod*; note that "timeperiod" is coded as "oera" throughout) using the `gls` function from the R package `nlme` [@pinheiro2023]. Because values from monthly censuses within each time period are subject to temporal autocorrelation, we included a continuous autoregressive temporal autocorrelation structure of order 1 (using the `CORCAR1` function). We compared this model to models fit without the autocorrelation structure and without the time period term using AIC. The model with both the time period term and the autocorrelation structure was the best-fitting model via AIC (@tbl-comp), and we used this model to calculate estimates and contrasts using the package `emmeans` [@lenth2023] (@tbl-ests, @tbl-contrasts). 



```{r, echo = F}

comp_mean_gls <- gls(smgran_comp ~ oera,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_notime <- gls(smgran_comp ~ 1,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_noautoc <- gls(smgran_comp ~ oera, data = compensation)

comp_mean_null <- gls(smgran_comp ~ 1, data = compensation)
```

# Tables

```{r, echo = F}
#| label: tbl-comp

compensation_comparison<- data.frame(
  `Model specification` = c("intercept + timeperiod + autocorrelation",
                            "intercept + autocorrelation",
                            "intercept + timeperiod",
                            "intercept"),
  AIC = c(AIC(comp_mean_gls),
          AIC(comp_mean_gls_notime),
          AIC(comp_mean_gls_noautoc),
          AIC(comp_mean_null))
)


knitr::kable(compensation_comparison)

```


```{r}
#| label: tbl-ests


comp_mean_gls_emmeans <- emmeans(comp_mean_gls, specs = ~ oera)

compensation_estimates <- oera_df %>%
  left_join(as.data.frame(comp_mean_gls_emmeans)) %>%
  select(-oera)
knitr::kable(compensation_estimates)

```

```{r}
#| label: tbl-contrasts


compensation_contrasts <-contrasts_df %>%
  left_join(as.data.frame(pairs(comp_mean_gls_emmeans))) %>%
  mutate(p.value = round(p.value, digits = 4)) %>%
  select(-contrast)
knitr::kable(compensation_contrasts)

```
\newpage





# Figures

```{r, echo = F}


# For figures:

theme_set(theme_bw())

both_scale <- scale_color_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)
both_fscale <- scale_fill_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)

era_df <- make_era_df()
# Alternatively, get the era_df from `data/`:
# era_df <- read.csv(here::here("data", "era_df.csv"))
era_df <- era_df %>%
  mutate(event_date = as.Date(event_date),
         no_name = "")

# Compensation plot
comp_mean_pred <-  as.data.frame(comp_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(compensation)

comp_title <- "Biomass compensation"


comp_plot <- ggplot(filter(comp_mean_pred, oplottype %in% c("CC", "EE")), aes(censusdate, emmean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = .2) +
  geom_line(aes(y = smgran_comp_ma)) +
  ggtitle(comp_title) +
  ylab(bquote((SG[E] - SG[C]) / KR[C])) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = -.05, yend = 1.4), linetype = 3)+
  xlab("") +
  theme(title = element_text(size = 2 +7),
        axis.title.y = element_text(size = 2 + 7), 
        axis.text = element_text(size = 2 +6)) + 
  xlab("")



```

```{r, echo = F, fig.dim = c(4,2)}
#| label: fig-plot
#| fig-cap: "Dynamics of biomass and rodent community composition over time. Lines represent the 6-month moving averages of biomass compensation. Dotted vertical lines mark the boundaries between time periods used for statistical analysis. Horizontal lines are time-period estimates from generalized least squares models, and the semitransparent envelopes mark the 95% confidence or credible intervals."

comp_plot
```

\newpage


# References

::: {#refs}

:::
